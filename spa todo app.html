<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>SPA todo app</title>
	<style>
		.hidden	{
			display: none;
		}
	</style>
	<script src="hua3.js"></script>
</head>
<body>
	<div>
		<button class="hua-tab" data-page='todo-new'>点击创建todo 页面</button>
		<button class="hua-tab" data-page='todo-wrapper'>点击显示todo list</button>
	</div>
	<div class="div-page todo-new">
		<input id="id-input" type="text">
		<button id="id-add-button">添加一个todo</button>
	</div>
	<div class="div-page todo-wrapper">
		<!-- balabala	 -->
	</div>
	
	<script>
		// todo API
		var createTodo = function(task) {
			t = {
				task: task,
				done: false,
			}
			return t 
		}
		// 保存todoList 到localStorage 中
		var saveTodos = function(todoList) {
			localStorage.todos = JSON.stringify(todoList)
		}
		// 保存todo
		var saveTodo = function(todo) {
			// var todoStr = localStorage.todos
			// if (todoStr == undefined) {
			// 	todoStr = '[]'
			// } 
			// var todoList = JSON.parse(todoStr)
			var todoList = loadTodos()
			todoList.push(todo)
			saveTodos(todoList)				
		}

		var loadTodos = function() {
			var todoStr = localStorage.todos
			if (todoStr == undefined) {
				todoStr = '[]'
			} 
			var todoList = JSON.parse(todoStr)
			return todoList
		}
	</script>
	<script>
		// 创建todo 的事件
		var bindEvents = function() {
			var button = e('#id-add-button')
			bindEvent(button, 'click', function(event) {
				var input = e('#id-input')
				var task = input.value
				log("task", task)
				var todo = createTodo(task)
				saveTodo(todo)
				// 点击 add
				// showTodoList()
			})

			// 切换页面的按钮
			bindAll('.hua-tab', 'click', function(event){
				var btn = event.target
				log('btn', btn)
				var page = btn.dataset.page
				// log('page', typeof(page))
				showPage(page)
				pushState(page)
				// if (page == 'todo-new') {
				// 	pageShowNew()
				// } else if (page = 'todo-wrapper') {
				// 	pageShowWrapper()
				// }
			})

			// 点击前进后退切换页面
			window.addEventListener('popstate', function(event){
				var state = event.state
				var className = state.page
				log('popstate', state, className)
				showPage(className)
			})
		}
	</script>
	<script>
		var templateTodo = function(todo) {
			var task = todo.task
			var t = `
				<div>
					${task}
				</div>
			`
			return t 
		}
		var insertTodos = function(todoList) {
			var todoWraper = e('.todo-wrapper')
			todoWraper.innerHTML = '' 	
			for (var i = 0; i < todoList.length; i++) {
				var todo = todoList[i]
				var t = templateTodo(todo)
				appendHTML(todoWraper, t)
			}
		}
	// 加载todo 显示在页面上
		var showTodoList = function() {
			var todoList = loadTodos()
			insertTodos(todoList)
		}
	</script>
	<script>
		// var bindAll = function(selector, eventName, callback) {
		var pushState = function(className) {
			// 在showPage 的同时切换地址信息
			// 创建历史记录
			// className is todo-new todo-wrapper 
			var pageName = className.split('-')[1]
			var url = 'spa%20todo%20app.html?page=' + pageName
			var state = {
				page: className,
			}
			history.pushState(state, 'title', url)
			document.title = pageName
		}
		var showPage = function(className) {
			var pages = es('.div-page')
			for (var i = 0; i < pages.length; i++) {
				var page = pages[i]
				page.classList.add('hidden')
			}
			var selector = '.' + className
			var todoNewDiv = e(selector)
			todoNewDiv.classList.remove('hidden')
			// 如果是wrapper 页面需要加载每个list
			if (className == 'todo-wrapper') {
				showTodoList()
			}
			// 在showPage 的同时切换地址信息
			// className is todo-new todo-wrapper 
			// var pageName = className.split('-')[1]
			// var url = 'spa%20todo%20app.html?page=' + pageName
			// history.pushState(null, 'title', url)
			// document.title = pageName
		}

		// var pageShowWrapper = function() {
		// 	var pages = es('.div-page')
		// 	for (var i = 0; i < pages.length; i++) {
		// 		pages[i].classList.add('hidden')
		// 		var todoWrapperDiv = e('.todo-wrapper')
		// 		todoWrapperDiv.classList.remove('hidden')
		// 		showTodoList()
		// 	}
		// }

	</script>
	<script>
		var initApp = function() {
			// 根据地址栏参数来显示不同的页面
			var query = location.search
			var [k, v] = query.slice(1).split('=')
			// 初始化为wrapper
			var page = 'wrapper'
			var validPages = ['new', 'wrapper']
			if (k == 'page') {
				if (validPages.includes(v)) {
					page = v
				}
			}
			var pageName = 'todo-' + page
			showPage(pageName)
			// pushState(pageName)
		}
		var __main = function() {
			bindEvents()
			// showTodoList()
			initApp()
		}
		__main()
	</script>
</body>
</html>